<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.15.10/dist/sweetalert2.all.min.js"></script>
    <link href="
    https://cdn.jsdelivr.net/npm/sweetalert2@11.15.10/dist/sweetalert2.min.css
    " rel="stylesheet">
    <title>Budget Dashboard</title>
</head>
<body>
    <form id="logoutBtn" action="/logout-user/" method="post">
        {% csrf_token %}
        <button type="submit">Logout</button>
    </form>
    <h1>Budget Dashboard</h1>
    <form method="post">
        {% csrf_token %}
        <label for="selected_date">Select Month:</label>
        <input type="date" id="selected_date" name="selected_date">
        <button type="button" id="addIncomeBtn">Add Income</button>
        <button type="button" id="addExpensesBtn">Add Expenses</button>
        <button type="button" id="viewBudgetBtn" style="display: none;">View Budget</button>
    </form>

    <form id="incomeForm" action="/add-income/" method="post" style="display: none;">
        <br>
        {% csrf_token %}
        <label for="income_amount">Enter Income Amount:</label>
        <input type="text" name="income_amount" id="income_amount">
        <input type="hidden" name="incomeYear" id="income_year">
        <input type="hidden" name="incomeMonth" id="income_month">
        <input type="hidden" name="incomeDate" id="income_date">
        <button type="submit">Add Income</button>
    </form>

    <form id="expensesForm" action="/add-expenses/" method="post" style="display: none;">
        <br>
        {% csrf_token %}
        <label for="expenses_amount">Enter Income Amount:</label>
        <input type="text" name="expenses_amount" id="expenses_amount">
        <input type="hidden" name="expenseYear" id="expense_year">
        <input type="hidden" name="expenseMonth" id="expense_month">
        <input type="hidden" name="expenseDate" id="expense_date">
        <button type="submit">Add Expenses</button>
    </form>

    <h2 id="budgetDetailsTitle"></h2>
    <div id="budgetDetails">
        <p id="income"></p>
        <p id="expenses"></p>
        <p id="remaining"></p>
    </div>

    <script>        
        const months = [
            "January", "February", "March", "April", "May", "June", 
            "July", "August", "September", "October", "November", "December"
        ];

        let today = new Date()
        let monthName = months[today.getMonth()]
        document.getElementById("selected_date").value = `${today.getFullYear()}-${(today.getMonth() + 1) < 10 ? '0' + (today.getMonth() + 1) : (today.getMonth() + 1)}-${today.getDate()}`

        window.onload = function() {
            document.getElementById("viewBudgetBtn").click();
        }   

        let date = new Date(document.getElementById("selected_date").value  + 'T00:00:00')
        let year = date.getFullYear()
        let month = date.getMonth() + 1
        monthName = months[date.getMonth()]
        let day = date.getDate()

        document.getElementById("budgetDetailsTitle").innerHTML = `Budget Details for ${monthName}`;
        document.getElementById("selected_date").addEventListener("change", function() {
            date = new Date(document.getElementById("selected_date").value + 'T00:00:00') 
            document.getElementById("viewBudgetBtn").click();
        })


        document.getElementById("viewBudgetBtn").addEventListener("click", function() {
            year = date.getFullYear()
            month = date.getMonth() + 1
            monthName = months[date.getMonth()]
            day = date.getDate()
            document.getElementById("budgetDetailsTitle").innerHTML = ``;
            document.getElementById("budgetDetailsTitle").innerHTML += `Budget Details for ${monthName}`;
            console.log(`/get-budget?year=${year}&month=${month}&day=${day}`)
            fetch(`/get-budget?year=${year}&month=${month}&day=${day}`)
            .then(response => response.json())
            .then(data => {
                if(data.error == 'no budget set'){
                    document.getElementById("budgetDetailsTitle").innerHTML = `No Income for ${monthName} Has Been set`;
                    document.getElementById("budgetDetails").style.display = "none";
                }
                else{
                    let incomeTotal = 0, expenseTotal = 0;
                    data.forEach(budget => {
                        console.log(parseFloat(budget.income))
                        incomeTotal += parseFloat(budget.income)
                        expenseTotal += parseFloat(budget.expenses)
                    });
                    console.log(incomeTotal, expenseTotal)
                    document.getElementById("income").innerHTML = `Income: $${incomeTotal}`;
                    document.getElementById("expenses").innerHTML = `Expenses: $${expenseTotal}`;
                    var remainingBudget = incomeTotal - expenseTotal;
                    document.getElementById("remaining").innerHTML = `Remaining Budget: $${remainingBudget}`;
                    document.getElementById("budgetDetails").style.display = "block";
                }
            })
            .catch(error => {
                    console.log(error)
            });
        });


        document.getElementById("addIncomeBtn").addEventListener("click", function() {
            if (month !== "") {
                document.getElementById("income_year").value = `${year}`;
                document.getElementById("income_month").value = `${month < 10 ? '0' + month : month}`;
                document.getElementById("income_date").value = `${day}`;
                document.getElementById("incomeForm").style.display = "block";
            } else {
                alert("Please select a month first.");
            }
        });

        document.getElementById("addExpensesBtn").addEventListener("click", function() {
            if (month !== "") {
                document.getElementById("expense_year").value = `${year}`
                document.getElementById("expense_month").value = `${month < 10 ? '0' + month : month}`;
                document.getElementById("expense_date").value = `${day}`
                document.getElementById("expensesForm").style.display = "block";
            } else {
                alert("Please select a month first.");
            }
        });
    </script>
</body>
</html>
